<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Campanha | Sombras do Abismo</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<body data-page="campanhas">
    <div class="background-overlay"></div>
    <div id="header-placeholder"></div>

    <main class="main-content" id="campaign-management-container" style="display: none;">
        <a href="campanhas.html" class="back-to-list-btn">&larr; Voltar para Campanhas</a>
        <div class="campaign-layout">
            <div class="campaign-main-content">
                <div class="content-box">
                    <!-- Adicionado ID para controle de visibilidade -->
                    <div id="campaign-header-and-tabs">
                        <div id="campaign-cover-image-display" class="campaign-cover-image"></div>
                        <div class="campaign-title-section">
                            <h2 id="campaign-title-display">Carregando...</h2>
                            <p id="campaign-synopsis-display" class="info-text"></p>
                            <button id="edit-campaign-info-btn" class="wizard-btn">Editar Informa√ß√µes</button>
                        </div>
                    </div>

                    <!-- Abas do Mestre -->
                    <div class="master-tabs">
                        <button class="tab-link active" data-tab="escudo-mestre">Escudo do Mestre</button>
                        <button class="tab-link" data-tab="mapa">Mapa</button>
                    </div>

                    <!-- Conte√∫do das Abas -->
                    <div class="tab-content active" id="escudo-mestre">
                        <h4>Recursos do Mestre</h4>
                        <p>Aqui voc√™ ver√° as fichas dos agentes e a lista de jogadores. As notifica√ß√µes e rolagens de dados aparecer√£o na barra lateral.</p>

                        <!-- Se√ß√£o para as fichas dos agentes -->
                        <div class="content-box" style="margin-top: 2rem; margin-bottom: 2rem;">
                            <h3 class="section-title">Agentes na Campanha</h3>
                            <div id="master-agents-grid" class="characters-grid">
                                <!-- Cards dos agentes da campanha ser√£o injetados aqui -->
                            </div>
                            <p class="empty-message" id="no-agents-for-master" style="display: none;">Nenhum agente nesta campanha ainda.</p>
                        </div>

                        <!-- Nova se√ß√£o para a lista de jogadores -->
                        <div class="content-box" style="margin-bottom: 2rem;">
                            <h3 class="section-title">Jogadores na Campanha</h3>
                            <div id="campaign-players-list" class="players-grid">
                                <!-- Cards de jogadores ser√£o injetados aqui -->
                                <p class="empty-message" id="no-players-in-campaign" style="display: none;">Nenhum jogador nesta campanha ainda.</p>
                            </div>
                        </div>

                        <div class="master-tools-grid">
                            <div class="tool-placeholder">Fichas de Monstros</div>
                        </div>

                        <!-- C√≥digo de Convite movido para baixo e em um content-box separado -->
                        <div class="content-box" style="margin-top: 2rem;">
                            <h3 class="section-title">C√≥digo de Convite</h3>
                            <p>Compartilhe este c√≥digo com seus jogadores para que eles possam se juntar √† sua campanha.</p>
                            <div class="invite-code-display">
                                <span id="campaign-invite-code-display">SDA-XXXX</span>
                                <button id="generate-invite-code-btn" class="wizard-btn small-btn">Gerar Novo</button>
                            </div>
                        </div>
                    </div>
        
                    <div class="tab-content" id="mapa">
                        <!-- Layout Unificado do Mapa para o Mestre -->
                        <div class="map-view-wrapper">
                            <!-- 1. Vis√£o da Galeria (Padr√£o) -->
                            <div id="gallery-view" class="gallery-view">
                                <div class="board-gallery-container">
                                    <h4>Pranchetas de Exibi√ß√£o</h4>
                                    <p class="info-text small-text">Cada prancheta √© um mapa ou imagem independente. Clique em uma para editar ou em "Abrir Mapa" para ver a prancheta selecionada em tela cheia.</p>
                                    <div id="board-gallery" class="board-gallery">
                                        <!-- A galeria de pranchetas ser√° populada aqui -->
                                    </div>
                                    <div class="gallery-actions">
                                        <button id="add-map-board-btn" class="wizard-btn small-btn" title="Adicionar Nova Prancheta">+</button>
                                        <button id="open-map-view-btn" class="wizard-btn">Abrir Mapa</button>
                                    </div>
                                </div>
                            </div>

                            <!-- 2. Vis√£o do Mapa (Oculta por padr√£o) -->
                            <div id="map-view" class="map-view" style="display: none;">
                                <button id="back-to-gallery-btn" class="back-to-list-btn" style="margin-bottom: 1rem;">&larr; Voltar para Galeria</button>
                                <div class="master-map-layout" id="master-map-layout">
                                    <div id="map-board" class="map-board" style="min-height: 70vh;">
                                        <div id="map-upload-placeholder" class="map-upload-placeholder">
                                            <p>Nenhum mapa carregado.</p>
                                            <p>Use os controles para carregar uma imagem de fundo.</p>
                                        </div>
                                        <button id="map-fullscreen-btn" class="map-fullscreen-button" title="Tela Cheia">
                                            <svg id="fullscreen-enter-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 2h-2v3h-3v2h5v-5zm-3-4V5h3v2h-3z"/></svg>
                                            <svg id="fullscreen-exit-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="display: none;"><path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/></svg>
                                        </button>
                                    </div>
                                    <div class="map-controls-panel">
                                        <h4>Controles do Mapa</h4>
                                        <h4>Adicionar Token</h4>
                                        <p class="info-text small-text">Arraste um agente para o mapa para criar seu token.</p>
                                        <div id="map-character-tokens" class="map-character-tokens"></div>
                                        <div class="map-tool-section" id="draw-tool-section">
                                            <div class="draw-controls-header">
                                                <button id="toggle-draw-mode-btn" class="wizard-btn small-btn">Ocultar √Årea</button>
                                                <div id="draw-tools-panel" class="draw-tools-panel" style="display: none;">
                                                    <button class="draw-tool-btn active" data-shape="square" title="Desenhar Quadrado">‚ñ†</button>
                                                    <button class="draw-tool-btn" data-shape="circle" title="Desenhar C√≠rculo">‚óè</button>
                                                    <button class="draw-tool-btn" data-shape="brush" title="Pincel Livre">üñåÔ∏è</button>
                                                </div>
                                            </div>
                                            <p class="info-text small-text">Clique em "Ocultar √Årea" e use as ferramentas para desenhar no mapa.</p>
                                        </div>
                                        <div class="map-config-collapsible">
                                            <h4 class="collapsible-header">Configura√ß√µes do Mapa &#9662;</h4>
                                            <div class="collapsible-content" style="display: none;">
                                                <div class="map-config-form">
                                                    <input type="file" id="map-upload-input" accept="image/*" style="display: none;">
                                                    <button class="wizard-btn small-btn" onclick="document.getElementById('map-upload-input').click()">Carregar Imagem de Fundo</button>
                                                    <button id="reset-map-btn" class="wizard-btn danger-btn small-btn">Limpar Prancheta</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Menu de Contexto Customizado para o Mapa (movido para dentro da aba) -->
                        <div id="map-context-menu" class="context-menu">
                            <ul>
                                <li id="remove-fog-area" style="display: none;">Remover N√©voa</li>
                                <!-- Outras op√ß√µes podem ser adicionadas aqui -->
                            </ul>
                        </div>
                        <!-- Menu de Contexto para Tokens -->
                        <div id="token-context-menu" class="context-menu">
                            <div id="lock-token-option" class="context-menu-option">Bloquear Token</div>
                            <div id="delete-token-option" class="context-menu-option">Remover Token</div>
                        </div>
                    </div>
        
                    <div class="campaign-actions-footer">
                        <span id="save-status-indicator" class="save-status"></span>
                        <button id="delete-campaign-btn" class="wizard-btn danger-btn">Excluir Campanha</button>
                    </div>
        
                </div>
            </div>

            <aside class="notification-sidebar">
                <div class="sidebar-content">
                    <h3>Log de Atividades</h3>
                    <div id="real-time-log" class="roll-log">
                        <p class="log-placeholder">As rolagens de dados e outras a√ß√µes dos jogadores aparecer√£o aqui.</p>
                    </div>
                </div>
            </aside>
        </div>
    </main>

    <!-- Novo Menu do Jogador -->
    <main class="main-content" id="player-view-container" style="display: none;">
        <a href="campanhas.html" class="back-to-list-btn">&larr; Voltar para Campanhas</a>
        
        <div class="content-box">
            <!-- Cabe√ßalho da Campanha -->
            <div class="campaign-display-header">
                <div id="player-view-campaign-cover" class="campaign-cover-image"></div>
                <div class="campaign-title-section">
                    <h2 id="player-view-campaign-title">Carregando...</h2>
                    <p id="player-view-campaign-synopsis" class="info-text"></p>
                </div>
            </div>

            <!-- Abas do Jogador -->
            <div class="master-tabs">
                <button class="tab-link active" data-tab="player-agents">Agentes</button>
                <button class="tab-link" data-tab="player-map">Mapa</button>
            </div>
    
            <!-- Agentes na Campanha -->
            <div class="tab-content active" id="player-agents">
                <h3 class="section-title">Agentes na Campanha</h3>
                <div id="campaign-agents-grid" class="characters-grid">
                    <!-- Cards de personagens ser√£o injetados aqui -->
                </div>
                <div id="no-agents-in-campaign" class="empty-state" style="display: none; padding: 2rem 0;">
                    <p class="empty-message">Nenhum agente nesta campanha ainda.</p>
                    <p class="empty-submessage">Adicione seu primeiro agente para come√ßar a jogar.</p>
                </div>
                <!-- Bot√£o de A√ß√£o -->
                <div style="text-align:center; margin-top:3rem;">
                    <button id="add-agent-to-campaign-btn" class="wizard-btn">Adicionar Agente</button>
                </div>
            </div>

            <!-- Mapa do Jogador -->
            <div class="tab-content" id="player-map">
                <!-- Galeria de Pranchetas para o Jogador -->
                <div class="board-gallery-container player-view">
                    <div id="player-board-gallery" class="board-gallery">
                        <!-- A galeria de pranchetas do jogador ser√° populada aqui -->
                    </div>
                </div>

                <div class="map-container player-view">
                    <div id="player-map-board" class="map-board">
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal para Editar Informa√ß√µes da Campanha -->
    <div id="edit-campaign-modal-overlay" class="modal-overlay">
        <div class="specialization-modal-content">
            <h1>Editar Campanha</h1>
            <form id="manage-campaign-form" class="personalization-form" novalidate>
                <div class="form-section" style="background: none; border: none; padding: 0;">
                    <div class="form-group">
                        <label for="campaign-title-modal">T√≠tulo da Campanha</label>
                        <input type="text" id="campaign-title-modal" name="title" required>
                    </div>
                    <div class="form-group">
                        <label for="campaign-synopsis-modal">Sinopse</label>
                        <textarea id="campaign-synopsis-modal" name="synopsis"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="campaign-image-modal-input">Imagem de Capa</label>
                        <div class="image-preview-container">
                            <img id="campaign-image-modal-preview" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjE4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjM2QzZDRmIj48L3JlY3Q+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiNhYWFiYmYiIGZvbnQtc2l6ZT0iMjBweCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiPjMwMHgyNTA8L3RleHQ+PC9zdmc+" alt="Pr√©-visualiza√ß√£o da capa">
                            <input type="file" id="campaign-image-modal-input" name="imageFile" accept="image/*" style="display: none;">
                            <button type="button" class="wizard-btn" onclick="document.getElementById('campaign-image-modal-input').click()">Alterar Imagem</button>
                        </div>
                    </div>
                </div>
            </form>
            <div class="modal-actions" style="margin-top: 2rem;">
                <button id="cancel-edit-btn" class="wizard-btn danger-btn">Cancelar</button>
                <button id="save-edit-btn" class="wizard-btn">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>

    <!-- Modal para Adicionar Agente √† Campanha -->
    <div id="add-agent-modal-overlay" class="modal-overlay">
        <div class="specialization-modal-content">
            <h1>Adicionar Agente √† Campanha</h1>
            <p class="info-text">Escolha um dos√£ seus agentes existentes ou crie um novo para se juntar a esta campanha.</p>
            
            <div id="select-agent-list" class="characters-grid modal-character-list">
                <!-- Lista de agentes do usu√°rio para sele√ß√£o -->
            </div>
    
            <div class="modal-actions" style="margin-top: 2rem; border-top: 1px solid var(--color-surface-2); padding-top: 2rem;">
                <button id="cancel-add-agent-btn" class="wizard-btn danger-btn">Cancelar</button>
                <a href="criar-agente.html" id="create-and-add-agent-btn" class="wizard-btn">Criar Novo Agente</a>
            </div>
        </div>
    </div>

    <!-- Modal para Visualizar Imagens (Pistas, Documentos) -->
    <div id="image-viewer-modal" class="modal-overlay">
        <div class="image-viewer-content">
            <button id="close-image-viewer-btn" class="close-viewer-btn">&times;</button>
            <img id="image-viewer-img" src="" alt="Visualiza√ß√£o de Imagem">
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- CORRE√á√ÉO: Carrega o cliente Socket.IO dinamicamente a partir da URL do backend -->
    <script>
        // Esta l√≥gica precisa estar ANTES de carregar o script.js
        const backendUrl = localStorage.getItem('devMode') === 'true' 
            ? 'http://localhost:3000' 
            : 'https://app-sombras.onrender.com';
        const socketScript = document.createElement('script');
        socketScript.src = `${backendUrl}/socket.io/socket.io.js`;
        document.body.appendChild(socketScript);
    </script>
    <script src="script.js"></script>
</body>
</html>