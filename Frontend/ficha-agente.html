<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha de Agente | Sombras do Abismo</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="/favicon.png" sizes="any" type="image/png">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <style>
        /* Estilos da √Årvore de Habilidades Integrada */
        #skill-tree-canvas {
            position: relative;
            width: 100%;
            height: 100%;
            min-height: 600px; /* Garante altura m√≠nima */
            background: radial-gradient(circle at center, #1b1b25 0%, #050505 100%);
            overflow: hidden;
        }

        #skill-tree-canvas svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .tree-node {
            position: absolute;
            width: 50px;
            height: 50px;
            background: #2a2a35;
            border: 2px solid #444;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(0,0,0,0.8);
            transform: translate(-50%, -50%);
        }

        .tree-node:hover {
            transform: translate(-50%, -50%) scale(1.2);
            z-index: 20;
            border-color: #fff;
        }

        /* Cores por Tipo */
        .tree-node.type-specialization { border-color: #ffd700; box-shadow: 0 0 15px #ffd700, inset 0 0 10px rgba(255, 215, 0, 0.2); }
        .tree-node.type-active { border-color: #ff4444; box-shadow: 0 0 15px #ff4444, inset 0 0 10px rgba(255, 68, 68, 0.2); }
        .tree-node.type-passive { border-color: #44ff44; box-shadow: 0 0 15px #44ff44, inset 0 0 10px rgba(68, 255, 68, 0.2); }
        .tree-node.type-reaction { border-color: #aa44ff; box-shadow: 0 0 15px #aa44ff, inset 0 0 10px rgba(170, 68, 255, 0.2); }

        .tree-path {
            fill: none;
            stroke: #555;
            stroke-width: 2;
            filter: drop-shadow(0 0 2px rgba(255,255,255,0.3));
            transition: stroke 0.3s;
        }

        .tree-path.active {
            stroke: var(--element-color, var(--color-primary));
            stroke-width: 3;
        }

        .tree-node.active {
            border-color: #fff;
            transform: translate(-50%, -50%) scale(1.2);
        }

        /* Painel de Detalhes da Habilidade */
        .skill-details-panel {
            position: absolute;
            right: 0;
            top: 0;
            width: 300px;
            height: 100%;
            background: rgba(10, 10, 15, 0.9);
            border-left: 1px solid #333;
            backdrop-filter: blur(10px);
            transform: translateX(100%);
            transition: transform 0.4s ease-in-out;
            z-index: 100;
            padding: 2rem;
            box-sizing: border-box;
            color: var(--color-text-primary);
            overflow-y: auto;
        }

        .skill-details-panel.visible {
            transform: translateX(0);
            box-shadow: -10px 0 30px rgba(0,0,0,0.5);
        }

        .skill-details-panel h3 {
            font-family: var(--font-display);
            font-size: 2rem;
            color: var(--page-color, var(--color-primary));
            margin: 0 0 1rem 0;
            letter-spacing: 1px;
        }

        .skill-details-panel .skill-details-meta {
            font-size: 0.9rem;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 1rem;
            display: block;
            border-bottom: 1px solid #444;
            padding-bottom: 0.5rem;
        }

        .skill-details-panel .skill-details-description {
            line-height: 1.6;
        }
    </style>
</head>
<body data-page="agentes">
    <div class="background-overlay"></div>
    <div id="header-placeholder"></div>

    <!-- Bot√£o para voltar para a campanha, inicialmente oculto -->
    <a href="#" id="back-to-campaign-btn" class="back-to-list-btn" style="display: none; margin: 1rem 0 0 2rem;">&larr; Voltar para a Campanha</a>

    <main id="sheet-container" class="sheet-container" style="display: none;">
        <!-- Cabe√ßalho da Ficha -->
        <header class="sheet-header">
            <div class="sheet-header-main-info">
                <span id="sheet-save-indicator" class="sheet-save-indicator">Salvando...</span>
                <div class="sheet-header-image-container">
                    <img id="sheet-char-image" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjM2QzZDRmIj48L3JlY3Q+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiNhYWFiYmYiIGZvbnQtc2l6ZT0iMjBweCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiPjE1MHgxNTA8L3RleHQ+PC9zdmc+" alt="Retrato do Agente" class="sheet-header-image">
                    <input type="file" id="sheet-image-input" accept="image/*" style="display: none;">
                    <div class="sheet-image-overlay"><span>Alterar</span></div>
                </div>
                <div class="sheet-header-text">
                    <h2 id="sheet-char-name">Nome do Agente</h2>
                    <p id="sheet-char-element" class="sheet-element-tag"></p>
                    <p id="sheet-char-class-player">Classe | Jogador</p>
                </div>
            </div>
        </header>

        <!-- Corpo da Ficha -->
        <div class="sheet-main-desktop">
            <!-- ================================================================== -->
            <!-- COLUNA ESQUERDA (DESKTOP) / SE√á√ÉO ATRIBUTOS (MOBILE) -->
            <!-- ================================================================== -->
            <div id="mobile-section-attributes" class="sheet-col-left sheet-mobile-section">
                <section class="sheet-section">
                    <h3>Atributos e Status</h3>
                    <!--
                        O conte√∫do original da coluna esquerda (atributos, barras de status, defesa, etc.)
                        permanece aqui dentro. Nenhuma mudan√ßa interna √© necess√°ria.
                    -->
                    <div class="primary-attributes-display">
                        <div class="primary-attr-block" data-attr="forca">
                            <div class="attr-main-info">
                                <span class="primary-attr-icon"><svg class="attr-svg-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M18.5,8.5c-1.1,0-2,0.9-2,2s0.9,2,2,2s2-0.9,2-2S19.6,8.5,18.5,8.5z M12,13c-1.66,0-3-1.34-3-3s1.34-3,3-3,3,1.34,3,3 S13.66,13,12,13z M5.5,10.5c1.1,0,2-0.9,2-2s-0.9-2-2-2s-2,0.9-2,2S4.4,10.5,5.5,10.5z M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10 s10-4.48,10-10S17.52,2,12,2z M12,20c-4.41,0-8-3.59-8-8s3.59-8,8-8s8,3.59,8,8S16.41,20,12,20z"/></svg></span>
                                <span class="primary-attr-label">For√ßa</span>
                                <span id="sheet-forca" class="primary-attr-value">--</span>
                            </div>
                            <div class="attr-controls"><button class="attr-btn" data-action="increase" title="Gastar 1 Ponto de Atributo">+</button></div>
                        </div>
                        <div class="primary-attr-block" data-attr="agilidade">
                            <div class="attr-main-info">
                                <span class="primary-attr-icon"><svg class="attr-svg-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4,18l8.5-6L4,6V18z M13,6v12l8.5-6L13,6z"/></svg></span>
                                <span class="primary-attr-label">Agilidade</span>
                                <span id="sheet-agilidade" class="primary-attr-value">--</span>
                            </div>
                            <div class="attr-controls"><button class="attr-btn" data-action="increase" title="Gastar 1 Ponto de Atributo">+</button></div>
                        </div>
                        <div class="primary-attr-block" data-attr="presenca">
                            <div class="attr-main-info">
                                <span class="primary-attr-icon"><svg class="attr-svg-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12,4.5C7,4.5,2.73,7.61,1,12c1.73,4.39,6,7.5,11,7.5s9.27-3.11,11-7.5C21.27,7.61,17,4.5,12,4.5z M12,14.5 c-2.48,0-4.5-2.02-4.5-4.5S9.52,5.5,12,5.5s4.5,2.02,4.5,4.5S14.48,14.5,12,14.5z M12,7.5C10.62,7.5,9.5,8.62,9.5,10 s1.12,2.5,2.5,2.5s2.5-1.12,2.5-2.5S13.38,7.5,12,7.5z"/></svg></span>
                                <span class="primary-attr-label">Presen√ßa</span>
                                <span id="sheet-presenca" class="primary-attr-value">--</span>
                            </div>
                            <div class="attr-controls"><button class="attr-btn" data-action="increase" title="Gastar 1 Ponto de Atributo">+</button></div>
                        </div>
                        <div class="primary-attr-block" data-attr="vitalidade">
                            <div class="attr-main-info">
                                <span class="primary-attr-icon"><svg class="attr-svg-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12,1L3,5v6c0,5.55,3.84,10.74,9,12c5.16-1.26,9-6.45,9-12V5L12,1z"/></svg></span>
                                <span class="primary-attr-label">Vitalidade</span>
                                <span id="sheet-vitalidade" class="primary-attr-value">--</span>
                            </div>
                            <div class="attr-controls"><button class="attr-btn" data-action="increase" title="Gastar 1 Ponto de Atributo">+</button></div>
                        </div>
                        <div class="primary-attr-block" data-attr="inteligencia">
                            <div class="attr-main-info">
                                <span class="primary-attr-icon"><svg class="attr-svg-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10s10-4.48,10-10S17.52,2,12,2z M12,20c-4.41,0-8-3.59-8-8s3.59-8,8-8 s8,3.59,8,8S16.41,20,12,20z M12.5,15.5h-1V14h1V15.5z M12.5,12.5h-1V7h1V12.5z"/></svg></span>
                                <span class="primary-attr-label">Intelig√™ncia</span>
                                <span id="sheet-inteligencia" class="primary-attr-value">--</span>
                            </div>
                            <div class="attr-controls"><button class="attr-btn" data-action="increase" title="Gastar 1 Ponto de Atributo">+</button></div>
                        </div>
                        <div id="class-specialization-block" class="primary-attr-block" data-attr="classe">
                            <div class="attr-main-info">
                                <span class="primary-attr-icon"><svg class="attr-svg-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg></span>
                                <span id="sheet-class-specialization" class="primary-attr-label">Classe</span>
                            </div>
                            <div class="attr-controls"><button class="attr-btn" data-action="specialize" title="Gastar 1 Ponto de Habilidade para Especializar">+</button></div>
                        </div>
                    </div>

                    <div class="status-bars-container">
                        <div class="status-bar-wrapper">
                            <div class="status-bar-info">
                                <span class="status-bar-label">HP</span>
                                <div class="status-bar-values-editable">
                                    <button class="status-btn minus" data-stat="hp_current" data-amount="-1" title="Diminuir HP">-</button>
                                    <span id="hp-current" class="status-value-display">--</span>
                                    <button class="status-btn plus" data-stat="hp_current" data-amount="1" title="Aumentar HP">+</button>
                                    <span class="separator">/</span>
                                    <input type="number" id="hp-max" class="status-input" title="HP M√°ximo">
                                </div>
                            </div>
                            <div class="status-bar-background"><div id="hp-bar-fill" class="status-bar-fill hp"></div></div>
                        </div>
                        <div class="status-bar-wrapper">
                            <div class="status-bar-info">
                                <span class="status-bar-label">SAN</span>
                                <div class="status-bar-values-editable">
                                    <button class="status-btn minus" data-stat="sanity_current" data-amount="-1" title="Diminuir Sanidade">-</button>
                                    <span id="sanity-current" class="status-value-display">--</span>
                                    <button class="status-btn plus" data-stat="sanity_current" data-amount="1" title="Aumentar Sanidade">+</button>
                                    <span class="separator">/</span>
                                    <input type="number" id="sanity-max" class="status-input" title="Sanidade M√°xima">
                                </div>
                            </div>
                            <div class="status-bar-background"><div id="sanity-bar-fill" class="status-bar-fill sanity"></div></div>
                        </div>
                        <div class="status-bar-wrapper">
                            <div class="status-bar-info">
                                <span class="status-bar-label">PA</span>
                                <div class="status-bar-values-editable">
                                    <button class="status-btn minus" data-stat="pa_current" data-amount="-1" title="Diminuir PA">-</button>
                                    <span id="pa-current" class="status-value-display">--</span>
                                    <button class="status-btn plus" data-stat="pa_current" data-amount="1" title="Aumentar PA">+</button>
                                    <span class="separator">/</span>
                                    <input type="number" id="pa-max" class="status-input" title="PA M√°ximo">
                                </div>
                            </div>
                            <div class="status-bar-background"><div id="pa-bar-fill" class="status-bar-fill pa"></div></div>
                        </div>
                    </div>
                    <div class="defense-container">
                        <div class="defense-shield">
                            <span id="sheet-defense" class="defense-value">--</span>
                        </div>
                        <span class="defense-label">Defesa Total</span>
                    </div>
                    <div class="proficiencies-box">
                        <h4>Profici√™ncias</h4>
                        <p id="sheet-proficiencies">Proficiente com: Armas simples.</p>
                    </div>
                    <div class="progression-container">
                        <div class="progression-grid">
                            <div class="progression-block">
                                <span class="progression-label">N√≠vel</span>
                                <span id="sheet-level" class="progression-value">--</span>
                            </div>
                            <div class="progression-block">
                                <span class="progression-label">NF (N√≠vel de Fragmenta√ß√£o)</span>
                                <div id="nf-control" class="progression-control">
                                    <button class="progression-btn minus" data-stat="nf" data-amount="-1" title="Diminuir NF">-</button>
                                    <span id="sheet-nf" class="progression-value">--</span>
                                    <button class="progression-btn plus" data-stat="nf" data-amount="1" title="Aumentar NF">+</button>
                                </div>
                            </div>
                            <div class="progression-block">
                                <span class="progression-label">Pontos de Atributo</span>
                                <span id="sheet-attribute-points" class="progression-value">--</span>
                            </div>
                            <div class="progression-block">
                                <span class="progression-label">Pontos de Habilidade</span>
                                <span id="sheet-skill-points" class="progression-value">--</span>
                            </div>
                        </div>
                        <div class="progression-actions">
                            <button id="add-xp-btn">Adicionar XP</button>
                            <button id="level-up-btn" style="display: none;">Subir de N√≠vel</button>
                        </div>
                    </div>
                    <div class="resistances-container">
                        <h3>Resist√™ncias</h3>
                        <div class="resistances-grid">
                            <div class="resistance-block">
                                <span class="resistance-label">Prote√ß√£o</span>
                                <span id="sheet-protection" class="resistance-value">0</span>
                            </div>
                            <div class="resistance-block">
                                <span class="resistance-label">Bal√≠stica</span>
                                <span id="sheet-res-balistica" class="resistance-value">0</span>
                            </div>
                            <div class="resistance-block">
                                <span class="resistance-label">Corte</span>
                                <span id="sheet-res-corte" class="resistance-value">0</span>
                            </div>
                            <div class="resistance-block">
                                <span class="resistance-label">Paranormal</span>
                                <span id="sheet-res-paranormal" class="resistance-value">0</span>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- ================================================================== -->
            <!-- COLUNA CENTRAL (DESKTOP) / SE√á√ÉO PER√çCIAS (MOBILE) -->
            <!-- ================================================================== -->
            <div id="mobile-section-proficiencies" class="sheet-col-center sheet-mobile-section">
                <section class="sheet-section">
                    <h3>Per√≠cias</h3>
                    <!--
                        O conte√∫do original da coluna central (lista de per√≠cias) permanece aqui.
                    -->
                    <div id="proficiencies-container" class="proficiencies-container">
                        <div class="proficiencies-header">
                            <span>Treinada</span>
                            <span>Per√≠cia</span>
                            <span>Rolar</span>
                            <span>Total</span>
                        </div>
                        <ul id="proficiencies-list" class="proficiencies-list">
                            <!-- As per√≠cias ser√£o populadas aqui -->
                        </ul>
                    </div>
                </section>
            </div>

            <!-- ================================================================== -->
            <!-- COLUNA DIREITA (DESKTOP) / M√öLTIPLAS SE√á√ïES (MOBILE) -->
            <!-- ================================================================== -->
            <div class="sheet-col-right">
                <!-- NOVO: Bot√µes de A√ß√£o Principais -->
                <div class="main-actions-container">
                    <button id="open-skills-modal-btn" class="wizard-btn">Habilidades</button>
                </div>

                <!-- Container para as se√ß√µes que ser√£o separadas no mobile -->
                <div class="actions-accordion">
                    <!-- Habilidades Desbloqueadas -->
                    <div id="mobile-section-skills" class="accordion-panel sheet-mobile-section">
                        <button class="accordion-header">Habilidades Desbloqueadas</button>
                        <div class="accordion-content">
                            <div id="unlocked-skills-container" class="skill-tree-container"></div>
                        </div>
                    </div>
                    <!-- Invent√°rio -->
                    <div id="mobile-section-inventory" class="accordion-panel sheet-mobile-section">
                        <button class="accordion-header">Invent√°rio</button>
                        <div class="accordion-content">
                            <ul id="sheet-inventory-list" class="inventory-list"></ul>
                            <form id="add-item-form" class="add-item-form">
                                <input type="text" id="add-item-input" class="add-item-input" placeholder="Novo item...">
                                <button type="submit" class="add-item-btn">+</button>
                            </form>
                        </div>
                    </div>
                    <!-- Detalhes e Origem (Lore) -->
                    <div id="mobile-section-lore" class="accordion-panel sheet-mobile-section mobile-default-visible">
                        <button class="accordion-header">Detalhes e Origem</button>
                        <div class="accordion-content">
                            <div class="details-group">
                                <h4>Apar√™ncia</h4>
                                <textarea id="sheet-appearance" class="details-textarea" rows="3"></textarea>
                            </div>
                            <div class="details-group">
                                <h4>Hist√≥ria</h4>
                                <textarea id="sheet-history" class="details-textarea" rows="5"></textarea>
                            </div>
                            <div class="details-group">
                                <h4>Motiva√ß√£o</h4>
                                <textarea id="sheet-motivation" class="details-textarea" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                    <!-- Rolagem de Dados -->
                    <div id="mobile-section-dice" class="accordion-panel sheet-mobile-section">
                        <button class="accordion-header">Rolagem de Dados</button>
                        <div class="accordion-content">
                            <form id="dice-roller-form" class="dice-roller-form">
                                <input type="number" id="dice-count" value="1">
                                <span>d</span>
                                <select id="dice-type">
                                    <option>4</option>
                                    <option>6</option>
                                    <option>8</option>
                                    <option>10</option>
                                    <option>12</option>
                                    <option selected>20</option>
                                    <option>100</option>
                                </select>
                                <span>+</span>
                                <input type="number" id="dice-bonus" value="0">
                                <button type="submit" class="roll-btn">Rolar</button>
                            </form>
                            <div id="roll-log" class="roll-log">
                                <p class="log-placeholder">O resultado das rolagens aparecer√° aqui.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="character-not-found" style="display: none; text-align: center; padding: 4rem;">
        <h2>Agente n√£o encontrado</h2>
        <p>O agente que voc√™ est√° procurando n√£o foi encontrado. <a href="agentes.html">Voltar para a lista de agentes.</a></p>
    </div>

    <!-- ================================================================== -->
    <!-- NOVO: MENU FLUTUANTE PARA NAVEGA√á√ÉO MOBILE -->
    <!-- ================================================================== -->
    <div class="mobile-fab-container">
        <div id="mobile-nav-menu" class="mobile-nav-menu">
            <a href="#mobile-section-lore">Lore</a>
            <a href="#mobile-section-attributes">Atributos</a>
            <a href="#mobile-section-proficiencies">Per√≠cias</a>
            <a href="#mobile-section-skills">Habilidades</a>
            <a href="#mobile-section-inventory">Invent√°rio</a>
            <a href="#mobile-section-dice">Dados</a>
        </div>
        <button id="mobile-fab" class="mobile-fab" aria-label="Abrir menu de se√ß√µes">
            <svg class="fab-icon icon-grid" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 11h8V3H3v8zm0 10h8v-8H3v8zm10 0h8v-8h-8v8zm0-18v8h8V3h-8z"/></svg>
            <svg class="fab-icon icon-close" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
    </div>

    <!-- Modal para Escolha de Especializa√ß√£o -->
    <div id="specialization-choice-overlay" class="modal-overlay">
        <div class="specialization-modal-content">
            <h1>Escolha sua Especializa√ß√£o</h1>
            <p class="info-text">Voc√™ atingiu o n√≠vel 5! Sua jornada o levou a um ponto de defini√ß√£o. Escolha o caminho que seu agente ir√° trilhar. Esta decis√£o √© permanente.</p>
            <div id="specialization-options-container" class="specialization-options-container">
                <!-- Op√ß√µes ser√£o inseridas aqui pelo script -->
            </div>
        </div>
    </div>

    <!-- NOVO: Modal da Constela√ß√£o de Habilidades -->
    <div id="skill-tree-modal-overlay" class="modal-overlay">
        <div class="skill-tree-modal-content">
            <button id="close-skills-modal-btn" class="close-viewer-btn">&times;</button>
            <div id="skill-tree-viewport" class="skill-tree-viewport">
                <div id="skill-tree-canvas">
                    <!-- A √°rvore de habilidades completa ser√° renderizada aqui -->
                </div>
            </div>
            <div class="skill-tree-instructions"><p>Use a roda do mouse para dar zoom e arraste para navegar.</p></div>
        </div>
    </div>

    <!-- NOVO: Modal da Constela√ß√£o de Habilidades -->
    <div id="skill-tree-modal-overlay" class="modal-overlay">
        <div class="skill-tree-modal-content">
            <button id="close-skills-modal-btn" class="close-viewer-btn">&times;</button>
            <div id="skill-tree-canvas"></div>
            <div id="skill-details-panel" class="skill-details-panel"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- Importa os dados das √°rvores -->
    <script src="skillTrees.js"></script>
    <script src="script.js"></script>
    
    <!-- Script de Integra√ß√£o da √Årvore -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const openSkillsBtn = document.getElementById('open-skills-modal-btn');
            const modalOverlay = document.getElementById('skill-tree-modal-overlay');
            const closeSkillsBtn = document.getElementById('close-skills-modal-btn');
            
            if(openSkillsBtn && modalOverlay) {
                openSkillsBtn.addEventListener('click', () => {
                    modalOverlay.classList.add('visible');
                    document.body.style.overflow = 'hidden';
                    setTimeout(renderSkillConstellation, 50); // Delay para renderizar ap√≥s a abertura
                });
            }
            if(closeSkillsBtn) {
                closeSkillsBtn.addEventListener('click', () => {
                    modalOverlay.classList.remove('visible');
                    document.body.style.overflow = '';
                });
            }

            function renderSkillConstellation() {
                const canvas = document.getElementById('skill-tree-canvas');
                const detailsPanel = document.getElementById('skill-details-panel');
                if (!canvas || !window.skillTrees) return;

                const classTextElement = document.getElementById('sheet-char-class-player');
                let classKey = 'belico'; // Padr√£o
                if (classTextElement) {
                    const text = classTextElement.textContent.toLowerCase();
                    if (text.includes('b√©lico') || text.includes('belico')) classKey = 'belico';
                    else if (text.includes('esot√©rico') || text.includes('esoterico')) classKey = 'esoterico';
                    else if (text.includes('erudito')) classKey = 'erudito';
                }

                const treeData = window.skillTrees[classKey];
                if (!treeData) return;

                canvas.innerHTML = ''; // Limpa o canvas
                const svgNS = "http://www.w3.org/2000/svg";
                const svgLayer = document.createElementNS(svgNS, "svg");
                canvas.appendChild(svgLayer);

                const width = canvas.clientWidth || 800;
                const height = canvas.clientHeight || 600;

                // 1. Desenha o n√≥ raiz (a classe)
                const classNode = createNode(treeData, treeData.position.x, treeData.position.y, 'class-root');
                canvas.appendChild(classNode);

                // 2. Desenha as especializa√ß√µes em um c√≠rculo
                const radius = Math.min(width, height) * 0.35; // AUMENTADO: Mais espa√ßo para as especializa√ß√µes
                const angleStep = (2 * Math.PI) / treeData.specializations.length;

                treeData.specializations.forEach((spec, index) => {
                    const angle = angleStep * index - (Math.PI / 2); // Come√ßa no topo
                    const specX = 50 + (radius / width * 100) * Math.cos(angle);
                    const specY = 50 + (radius / height * 100) * Math.sin(angle);

                    const specNode = createNode(spec, specX, specY, 'specialization');
                    canvas.appendChild(specNode);
                    drawConnection(treeData.position, {x: specX, y: specY});

                    // 3. Desenha as habilidades de cada especializa√ß√£o
                    const skillRadius = Math.min(width, height) * 0.12; // ALTERADO: Raio relativo para as habilidades
                    spec.skills.forEach((skill, skillIndex) => {
                        const skillAngle = angle + (skillIndex - (spec.skills.length - 1) / 2) * 0.35; // AUMENTADO: Espalha mais as habilidades
                        const skillX = specX + (skillRadius / width * 100) * Math.cos(skillAngle);
                        const skillY = specY + (skillRadius / height * 100) * Math.sin(skillAngle);

                        const skillNode = createNode(skill, skillX, skillY, skill.type);
                        canvas.appendChild(skillNode);
                        drawConnection({x: specX, y: specY}, {x: skillX, y: skillY});
                    });
                });

                function createNode(data, x, y, type) {
                    const el = document.createElement('div');
                    el.className = `tree-node type-${type}`;
                    el.style.left = `${x}%`;
                    el.style.top = `${y}%`;
                    el.innerHTML = `<span style="font-size:20px; pointer-events:none;">${data.icon || 'üîπ'}</span>`;

                    el.addEventListener('click', () => {
                        document.querySelectorAll('.tree-node.active').forEach(n => n.classList.remove('active'));
                        el.classList.add('active');
                        
                        detailsPanel.innerHTML = `
                            <h3>${data.name || 'Habilidade'}</h3>
                            <p class="skill-details-meta">${data.type || 'Classe'}</p>
                            <p class="skill-details-description">${data.description || 'Sem descri√ß√£o.'}</p>
                            ${data.cost ? `<p><strong>Custo:</strong> ${data.cost} Ponto(s)</p>` : ''}
                        `;
                        detailsPanel.classList.add('visible');
                    });

                    return el;
                }

                function drawConnection(pos1, pos2) {
                    const p1 = { x: (pos1.x / 100) * width, y: (pos1.y / 100) * height };
                    const p2 = { x: (pos2.x / 100) * width, y: (pos2.y / 100) * height };

                    const path = document.createElementNS(svgNS, "path");
                    const d = `M ${p1.x} ${p1.y} C ${p1.x} ${p1.y + (p2.y - p1.y) / 2}, ${p2.x} ${p2.y - (p2.y - p1.y) / 2}, ${p2.x} ${p2.y}`;
                    path.setAttribute("d", d);
                    path.setAttribute("class", "tree-path");
                    svgLayer.appendChild(path);
                }

                // Fechar o painel se clicar fora dele (no canvas)
                canvas.addEventListener('click', (e) => {
                    if (e.target === canvas) {
                        detailsPanel.classList.remove('visible');
                        // Remove a classe 'active' de qualquer n√≥ selecionado ao fechar o painel
                        document.querySelectorAll('.tree-node.active').forEach(n => n.classList.remove('active'));
                    }
                });
            }
        });
    </script>
</body>
</html>
                    canvas.appendChild(el);
                });
            }
        });
    </script>
</body>
</html>